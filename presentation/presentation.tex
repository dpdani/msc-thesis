\documentclass[aspectratio=169]{beamer}

\usepackage{lipsum}
\usepackage{datetime2}
\usepackage{ulem}
\usepackage{wasysym}
\usepackage{pythontex}
\usepackage{listings}

\title{A Concurrent Hash Table for CPython}
\subtitle{MSc Thesis Dissertation}
\date{2024-10-16}
\institute{Universit√† degli Studi di Trento, DISI}
\author{Daniele Parmeggiani}

\usetheme{dpb}

\begin{document}
\pagenumbering{gobble}

\inserttitleframe

\pagenumbering{arabic}

\begin{frame}
    \frametitle{Python and CPython}
    \begin{center}
        \includegraphics[width=0.33\textwidth]{./python-logo}
    \end{center}
\end{frame}

\begin{frame}
    \frametitle{Back to \sout{the future} 1994}
    \begin{center}
        \includegraphics[width=0.66\textwidth]{./Winnt35}
    \end{center}
\end{frame}

\begin{frame}
    \frametitle{CPython and its GIL}

    \begin{columns}
        \begin{column}{0.5\textwidth}
            \centering\includegraphics[width=0.66\textwidth]{./python-gil}
        \end{column}
        \begin{column}{0.5\textwidth}<2->
            \begin{center}
                \Huge{3.13}

                \Large{Free-threading}
            \end{center}
        \end{column}
    \end{columns}
\end{frame}

\begin{frame}
    \frametitle{java.util.concurrent}

    \begin{itemize}
        \item Semaphore \checked
        \item CyclicBarrier \checked
        \item Lock \checked
        \item Concurrent{\textbf{HashMap}}
        \item ConcurrentLinked{\textbf{Queue}}
        \item CopyOnWriteArray{\textbf{List}}
        \item Atomic{\textbf{Boolean}}
        \item Atomic{\textbf{Integer}}
        \item Atomic{\textbf{Reference}}
        \item \ldots
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{cereggii}

    \begin{columns}
        \begin{column}{0.5\textwidth}
            Thread synchronization utilities for Python.

            \vspace{1cm}

            The \textit{Cereus Greggii} is a flower native to Arizona, New Mexico, Texas, and some parts of northern Mexico.

            This flower blooms just one summer night every year and in any given area, all these flowers bloom in synchrony.

            \vspace{1cm}
            
            \tiny\url{https://github.com/dpdani/cereggii}
        \end{column}
        \begin{column}{0.5\textwidth}
            \centering\includegraphics[width=\textwidth]{./cereggii}
        \end{column}
    \end{columns}
\end{frame}

\begin{frame}
    \frametitle{AtomicDict}

    \begin{columns}
        \begin{column}{0.5\textwidth}
            Exposes a so-called \textit{natural parallelism}.

            High-level design:
            \begin{itemize}
                \item linear probing
                \item resizable
                \item double-hashing
                \item split index and data tables
                \item lock-free*
            \end{itemize}
        \end{column}
        \begin{column}{0.5\textwidth}
            Mostly inspired by:
            \begin{itemize}
                \item T.\ Maier's Growt concurrent hash table, and
                \item CPython's built-in sequential hash table (dict).
            \end{itemize}
        \end{column}
    \end{columns}
\end{frame}

\begin{frame}
    \frametitle{Concurrent Resizing}

    \begin{figure}
        \centering\includegraphics[width=0.5\textwidth]{./migration}
        \caption{Growt's migration process.\footnote{%
            T.\ Maier et al., Concurrent Hash Tables: Fast and General(?)!, Fig.~1.
        }}\label{fig:maier-migration}
    \end{figure}
\end{frame}

\begin{frame}
    \frametitle{Double-Hashing}

    \begin{itemize}
        \item Growt uses most-significant bits as position
        \item dict uses least-significant bits as position
        \item<2-> AtomicDict:
        \begin{enumerate}
            \item<3-> get an object's hash (as generated by CPython)
            \item<4-> re-hash with CRC32
            \item<5-> use most-significant bits as position
        \end{enumerate}
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{Split Index and Data Tables}

    \begin{columns}
        \begin{column}{0.5\textwidth}
            \begin{itemize}
                \item put keys and values into a separate \textit{data} table
                \item actual hash table is an \textit{index} over the data table
                \item<3-> so that:
                \begin{itemize}
                    \item<3-> the index stays sparse to better handle collisions
                    \item<3-> the large entry size decreases false sharing
                \end{itemize}
            \end{itemize}
        \end{column}

        \begin{column}{0.5\textwidth}<2->
            \begin{itemize}
                \item size of an index slot: 1 to 8 bytes
                \begin{itemize}
                    \item dependent on capacity
                \end{itemize}
                \item size of a data entry: 32 bytes
            \end{itemize}
        \end{column}
    \end{columns}
\end{frame}

\begin{frame}
    \frametitle{Lock-freedom}

    \begin{definition}
        At least one thread can always make progress.
        (No locks $\Rightarrow$ no deadlocks.)
    \end{definition}
    
    \vspace{1cm}

    \begin{itemize}
        \item<2-> For AtomicDict:
        \begin{itemize}
            \item<2-> no deadlocks!
            \item<2-> (unless a resizing is in progress)
            \item<2-> lock-free resizing is not practical
            \item<2-> if you correctly set {\footnotesize\texttt{min\_size}}, no resizing ever happens
        \end{itemize}
    \end{itemize}
\end{frame}

\begin{frame}[fragile]
    \frametitle{Small Contributions}

    \begin{itemize}
        \item Partitioned iterations
        \begin{tiny}
            \begin{lstlisting}[language=Python]
d = AtomicDict(...)

def my_thread(thread_id, threads_count):
    for key, value in d.fast_iter(partitions=threads_count, this_partition=thread_id)
        do_some_stuff(key, value)
            \end{lstlisting}
        \end{tiny}
        \item<2-> Reduce
        \begin{tiny}
            \begin{column}{\textwidth}<2->
            \begin{lstlisting}[language=Python]
d = AtomicDict(...)

data = [
    ("red", 1),
    ("green", 42),
    ("blue", 3),
    ("red", 5),
]

def count(key, current, new):
    if current is NOT_FOUND:
        return new
    return current + new

d.reduce(data, count)
            \end{lstlisting}
            \end{column}
        \end{tiny}
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{Python Language Summit}
    \begin{columns}
        \begin{column}{\textwidth}<2->
            \begin{center}
                \includegraphics[width=0.66\textwidth]{./lang-summit}

                Pittsburgh (USA), May 2024.
            \end{center}
        \end{column}
    \end{columns}
\end{frame}

\begin{frame}
    \frametitle{Summary}

    \begin{columns}
        \begin{column}{0.5\textwidth}
            \begin{enumerate}
                \item Python = language / CPython = interpreter
                \item CPython and its GIL
                \begin{itemize}
                    \item historical rationale
                \end{itemize}
                \item Free-threading in CPython 3.13
                \begin{itemize}
                    \item per-object locks
                \end{itemize}
                \item Java has atomic data structures, Python doesn't
                \item cereggii
                \begin{itemize}
                    \item atomic data structures for Python (currently: AtomicRef, AtomicInt, AtomicDict)
                \end{itemize}
            \end{enumerate}
        \end{column}
        \begin{column}{0.5\textwidth}
            \begin{enumerate}
                \setcounter{enumi}{5}
                \item AtomicDict
                \begin{itemize}
                    \item natural parallelism
                    \item inspired by:
                    \begin{itemize}
                        \item Maier's Growt (concurrent)
                        \item CPython's dict (sequential)
                    \end{itemize}
                    \item linear probing
                    \item resizable
                    \item double-hashing
                    \item split index and data tables
                    \item lock-free*
                \end{itemize}
                \item Python Language Summit
            \end{enumerate}
        \end{column}
    \end{columns}
\end{frame}

\end{document}
